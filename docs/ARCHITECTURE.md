# Архитектура Приложения

## Обзор
Recod — это нативное приложение для macOS, созданное с использованием **SwiftUI 6** и **SwiftData**. Оно следует стандартному паттерну MVVM (Model-View-ViewModel), с сильным акцентом на современную конкурентность (`async/await`) и декларативный UI.

## Структура Проекта

```
Sources/
├── App/                 # Точка входа (RecodApp.swift), Глобальное состояние
├── Features/            # Модули функциональности
│   ├── Settings/        # Экран настроек и его компоненты
│   └── History/         # Логика и views истории
├── Core/
│   ├── Utilities/       # Помощники (WindowAccessor и т.д.)
│   └── Models/          # Общие модели (HotKeyShortcut)
├── DesignSystem/        # UI Константы (AppTheme) и Стили
├── UI/                  # Переиспользуемые UI компоненты (KeyView)
└── Model/               # SwiftData Модели (Recording.swift)
```

## Хранение Данных (SwiftData)
Приложение использует SwiftData для сохранения записей.
- **Модель**: `Recording` (в `Sources/Model/Recording.swift`).
- **Контейнер**: Инициализируется в `RecodApp.swift`.
- **Внедрение**: Передается через `.modelContainer` в WindowGroup. `ModelContext` также внедряется в `AppState` для немедленного сохранения новых записей.
- **Использование**: Views используют `@Query` для чтения и `@Environment(\.modelContext)` для записи/удаления.
- **Реактивность**: Когда запись завершается, `AppState` создает объект `Recording` и вставляет его в контекст. `HistoryView` (наблюдающий через `@Query`) обновляется мгновенно.

## Аудио Подсистема
Запись и воспроизведение аудио обрабатываются `AudioPlayer` и `AudioRecorder`.

### Запись (AudioRecorder)
Класс `AudioRecorder` управляет процессом захвата звука:
- **Стабильный аудио-граф**: Все аудио-узлы инстанцируются и конфигурируются один раз при запуске. Это обеспечивает высокую производительность и отсутствие крашей при пересоздании движка.
- **Умный прогрев (Pre-warming)**: При старте приложения выполняется кратковременный запуск движка (1 сек), чтобы инициализировать оборудование (HAL) и гарантировать, что первая запись не будет пустой.
- **Приватность**: После прогрева и после каждой записи аудио-движок полностью останавливается (`engine.stop()`), что отключает системный индикатор использования микрофона.
- **Двухканальная запись (Стерео)**:
  - **Левый канал**: Микрофон.
  - **Правый канал**: Системный звук (через `ScreenCaptureKit` и `StreamOutput`).
- **Микширование**:
  - `mainMixerNode` движка заглушен (`outputVolume = 0`).
  - Используется отдельный `recordingMixer`, с которого снимается tap только во время активной записи.
- **Формат**: Файлы сохраняются в формате **Linear PCM Stereo 16kHz**.

### Обзор Процесса
- **Запись**: Стерео-микс (L: Microphone, R: System Audio) через `AVAudioEngine` и `ScreenCaptureKit`.
- **Транскрибация**: WhisperKit (CoreML).
- **Сегментация**: Сохранение детальных сегментов (`TranscriptionSegment`) с таймкодами (точность до 0.1с) в SwiftData. Это позволяет отображать поминутный разбор записи в истории.
- **Очистка**: Автоматическое удаление служебных токенов модели (`<|...|>`) перед сохранением.

### Воспроизведение
Использует стандартный `AVAudioPlayer`.

## Движок Транскрибации
Транскрибация обрабатывается `TranscriptionService` на базе **WhisperKit** (CoreML/ANE).
- Двухэтапный пайплайн: **detectLanguage** → **transcribe (task: .transcribe)** для предотвращения непреднамеренного перевода.
- Модели скачиваются и управляются через `WhisperModelManager` (загрузчик WhisperKit).

## Эффект "Стеклянного" Окна
Для достижения вида "Superwhisper" (глубокая прозрачность):
1.  **NSWindow**: Базовое окно настроено как `isOpaque = false` и `backgroundColor = .clear` через `WindowAccessor`.
2.  **SwiftUI Background**: Корневое view применяет `.background(.ultraThinMaterial)`.
3.  **Результат**: Обои рабочего стола пользователя просвечивают через размытый контент приложения.

## Добавление Новых Функций
1.  **Модель**: Определите структуры данных в `Sources/Model`.
2.  **View**: Создайте UI в `Sources/Features/<FeatureName>`.
3.  **Интеграция**: Добавьте в боковую панель `SettingsView` (если это настройка) или `MenuBarContent` (если это основное действие).
4.  **Стиль**: Строго используйте `AppTheme` для констант верстки.
